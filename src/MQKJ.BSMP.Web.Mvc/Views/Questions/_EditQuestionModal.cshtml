@using Abp.Extensions
@using MQKJ.BSMP.Questions
@using MQKJ.BSMP.Questions.Dtos
@using MQKJ.BSMP.SceneFiles.Dto
@using MQKJ.BSMP.Scenes.Dto
@using MQKJ.BSMP.TagTypes.Dtos
@using MQKJ.BSMP.Web.Models.Common.Modals
@model MQKJ.BSMP.Questions.Dtos.GetQuestionForEditOutput
@{
    Layout = null;
    var scenes = (List<GetScenesListDto>)ViewBag.Scenes;
    var imgs = (List<GetSceneFileOutput>)ViewBag.SceneFiles;
    var tagTypes = (IEnumerable<TagTypeListDto>)ViewBag.TagType;
    var question = Model.Question;
    var answers = question.Answers.ToList();
    #region 选项
    var answerFemale1 = answers.FirstOrDefault(a => a.QuestionType == QuestionGender.F && a.Sort == 0);
    var answerFemale2 = answers.FirstOrDefault(a => a.QuestionType == QuestionGender.F && a.Sort == 1);
    var answerFemale3 = answers.FirstOrDefault(a => a.QuestionType == QuestionGender.F && a.Sort == 2);
    var answerFemale4 = answers.FirstOrDefault(a => a.QuestionType == QuestionGender.F && a.Sort == 3);

    var answerMale1 = answers.FirstOrDefault(a => a.QuestionType == QuestionGender.M && a.Sort == 0);
    var answerMale2 = answers.FirstOrDefault(a => a.QuestionType == QuestionGender.M && a.Sort == 1);
    var answerMale3 = answers.FirstOrDefault(a => a.QuestionType == QuestionGender.M && a.Sort == 2);
    var answerMale4 = answers.FirstOrDefault(a => a.QuestionType == QuestionGender.M && a.Sort == 3);
    #endregion
}
@Html.Partial("~/Views/Shared/Modals/_ModalHeader.cshtml", new ModalHeaderViewModel("编辑问题"))

<div class="modal-body">
    <form name="UserEditForm" role="form" novalidate class="form-validation">
        <input type="hidden" name="Id" value="@Model.Question.Id" />
        <ul class="nav nav-tabs tab-nav-right" role="tablist">
            <li role="presentation" class="active"><a href="#create-question-details" data-toggle="tab">题库</a></li>
            @*<li role="presentation"><a href="#create-question-roles" data-toggle="tab">@L("QuestionRoles")</a></li>*@
        </ul>
        <div class="tab-content">
            <div role="tabpanel" class="tab-pane animated fadeIn active" id="create-question-details">
                <div class="row clearfix" style="margin-top:10px;">
                    <div class="col-sm-6">
                        <div class="form-group form-float">
                            <div class="form-line">
                                <select class="selectpicker input-select" name="SceneId">
                                    <option>选择场景</option>
                                    @foreach (var scene in scenes)
                                    {
                                    <option selected="@(question.SceneId==scene.Id)" value="@scene.Id">@scene.SceneName</option>
                                    }
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6">
                        <div class="form-group form-float">
                            <div class="form-line">
                                <select class="selectpicker input-select" name="Pursuer">
                                    <option>男生版/女生版</option>
                                    <option value="0" selected="@(question.Pursuer==QuestionGender.M)">男生版</option>
                                    <option value="1" selected="@(question.Pursuer==QuestionGender.F)">女生版</option>
                                </select>
                                @*<label class="form-label">被追求性别</label>*@
                            </div>
                        </div>
                    </div>
                </div>
            @foreach (var tagType in tagTypes)
            {
                <div class="row clearfix">
                    <div class="col-sm-12"><h5>@tagType.TypeName</h5></div>
                    <div class="col-sm-12">
                        <div class="form-group form-float">
                             @if(tagType.Code == "TopicTag" ){
                                        //话题标签
                                    <div class="g-container">
                                        <form action="" class="basic-grey">
                                              <label for="lastname" class="control-label1"> 标签选择: </label>
                                               <div class="Companies">
                                                    <input class="form-control1" type="text" placeholder="请选择" id="js-groupId2">
                                                    <input type="hidden" id="groupId2">
                                                    <!-- <div class="selectbtn">确定</div> -->
                                                    <ul id="groupid2">
                                                     @foreach (var tag in tagType.Tags)
                                                    {
                                                        <li data-id="@tag.Id" name="tags" value="@tag.Id"><a href="javascript:void(0)">@tag.TagName</a></li>
                                                    }
                                                    </ul>
                                               </div>
                                        </form>
                                        <div class="selectbox">
                                          @foreach (var tag in tagType.Tags)
                                         {
                                            var questionTags = question.QuestionTags.FirstOrDefault(qt => qt.Tag.Id == tag.Id);
                                            @if(questionTags!=null){
                                                <div class="boxlist">
                                                    <button type="button" class="btn @(questionTags!=null?"btn-success":"btn-default") tag-button" name="tags" value="@tag.Id" questionTagsId="@(questionTags==null?0:questionTags.Id)">@tag.TagName</button>
                                                    <span class="deletebtn"><i class="mdui-icon material-icons">&#xe5cd;</i></span>
                                                </div>
                                            }
                                        }         
                                        </div>
                                          
                                    </div>
                                        }else{
                                             @foreach (var tag in tagType.Tags)
                                        {
                                            var questionTags = question.QuestionTags.FirstOrDefault(qt => qt.Tag.Id == tag.Id);
                                            <button type="button" class="btn @(questionTags!=null?"btn-success":"btn-default") tag-button" name="tags" value="@tag.Id" questionTagsId="@(questionTags==null?0:questionTags.Id)">@tag.TagName</button>
                                         }
                                        }
                           
                        </div>
                    </div>
                </div>
            }
                <div class="row clearfix">
                    <div class="col-sm-6">
                        <div class="col-sm-12">
                            <h5>女生画面</h5>
                        </div>
                        <div class="row clearfix">
                            <div class="col-sm-12">
                                <div class="form-group form-float">
                                    <label class="form-label">*背景故事</label>
                                    <div class="form-line">
                                        <textarea type="text" id="BackgroundStoryFemale-Edit" name="BackgroundStoryFemale" class="form-control background-story" required >@Html.Raw(Model.Question.BackgroundStoryFemale)</textarea>
                                        @*<div id="BackgroundStoryFemale-Edit">
                                            @if (Model.Question.BackgroundStoryMale.Contains("<"))
                                            {
                                                @Html.Raw(Model.Question.BackgroundStoryFemale)
                                            }
                                            else
                                            {
                                                <p>@Model.Question.BackgroundStoryFemale</p>
                                            }
                                        </div>*@
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row clearfix">
                            <div class="col-sm-12">
                                <div class="form-group form-float">
                                    <div class="form-line">
                                        <input type="text" id="BackgroundStoryMale-Edit" answer-name="AnswerFemale" name="AnswerFemaleA" class="form-control" required maxlength="160" value="@(answerFemale1==null?"":answerFemale1.Title)" optionId="@(answerFemale1==null?0:answerFemale1.Id)">
                                        <label class="form-label">*选项A</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row clearfix">
                            <div class="col-sm-12">
                                <div class="form-group form-float">
                                    <div class="form-line">
                                        <input type="text" answer-name="AnswerFemale" name="AnswerFemaleB" class="form-control" required maxlength="160" value="@(answerFemale2==null?"":answerFemale2.Title)" optionId="@(answerFemale2==null?0:answerFemale2.Id)">
                                        <label class="form-label">*选项B</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row clearfix">
                            <div class="col-sm-12">
                                <div class="form-group form-float">
                                    <div class="form-line">
                                        <input type="text" answer-name="AnswerFemale" name="AnswerFemaleC" class="form-control" maxlength="160" value="@(answerFemale3==null?"":answerFemale3.Title)" optionId="@(answerFemale3==null?0:answerFemale3.Id)">
                                        <label class="form-label">选项C</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row clearfix">
                            <div class="col-sm-12">
                                <div class="form-group form-float">
                                    <div class="form-line">
                                        <input type="text" answer-name="AnswerFemale" name="AnswerFemaleD" class="form-control" maxlength="160" value="@(answerFemale4==null?"":answerFemale4.Title)" optionId="@(answerFemale4==null?0:answerFemale4.Id)">
                                        <label class="form-label">选项D</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6">
                        <div class="col-sm-12">
                            <h5>男生画面</h5>
                        </div>
                        <div class="row clearfix">
                            <div class="col-sm-12">
                                <div class="form-group form-float">
                                    <label class="form-label">*背景故事</label>
                                    <div class="form-line">
                                        <textarea type="text" id="BackgroundStoryMale-Edit" name="BackgroundStoryMale" class="form-control background-story" required maxlength="160">@question.BackgroundStoryMale</textarea>
                                        
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row clearfix">
                            <div class="col-sm-12">
                                <div class="form-group form-float">
                                    <div class="form-line">
                                        <input type="text" answer-name="AnswerMale" name="AnswerMaleA" class="form-control" required maxlength="160" value="@(answerMale1==null?"":answerMale1.Title)" optionId="@(answerMale1==null?0:answerMale1.Id)">
                                        <label class="form-label">*选项A</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row clearfix">
                            <div class="col-sm-12">
                                <div class="form-group form-float">
                                    <div class="form-line">
                                        <input type="text" answer-name="AnswerMale" name="AnswerMaleB" class="form-control" required maxlength="160" value="@(answerMale2==null?"":answerMale2.Title)" optionId="@(answerMale2==null?0:answerMale2.Id)">
                                        <label class="form-label">*选项B</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row clearfix">
                            <div class="col-sm-12">
                                <div class="form-group form-float">
                                    <div class="form-line">
                                        <input type="text" answer-name="AnswerMale" name="AnswerMaleC" class="form-control" maxlength="160" value="@(answerMale3==null?"":answerMale3.Title)" optionId="@(answerMale3==null?0:answerMale3.Id)">
                                        <label class="form-label">选项C</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row clearfix">
                            <div class="col-sm-12">
                                <div class="form-group form-float">
                                    <div class="form-line">
                                        <input type="text" answer-name="AnswerMale" name="AnswerMaleD" class="form-control" maxlength="160" value="@(answerMale4==null?"":answerMale4.Title)" optionId="@(answerMale4==null?0:answerMale4.Id)">
                                        <label class="form-label">选项D</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
           
                </div>
                  <!--题目作者-->
                <div class="row clearfix" style="margin-top: 10px;">
                    <h5>题目作者</h5>
                    <div class="col-sm-12">
                    <div class="author">作者：</div>
                    <div class="inp"><input type="text" id="Author-edit" name="Author" class="form-control" value="@(question.Author == null ? "" : question.Author)"></div>
                    </div>
                 </div>
                <div class="row clearfix" style="margin-top: 10px;">
                    <h5>选择图片</h5>
                    <div class="col-sm-10 col-sm-push-1">
                        <input type="hidden" value="" id="DefaultImgId" name="DefaultImgId" />
                        <!--Carousel Wrapper-->
                        <div id="multi-item-example" class="carousel slide carousel-multi-item" data-ride="carousel" data-interval="false">
                            @if (imgs != null && imgs.Count > 3)
                            {
                                <!--Controls-->
                            <div class="controls-top">
                                <a class="btn btn-primary btn-circle waves-effect waves-circle waves-float " href="#multi-item-example" data-slide="prev"><i class="fa fa-chevron-left"></i></a>
                                <a class="btn btn-primary btn-circle waves-effect waves-circle waves-float " href="#multi-item-example" data-slide="next"><i class="fa fa-chevron-right"></i></a>
                            </div>
 <!--/.Controls-->
                            }
                            <!--Slides-->
                            <div class="carousel-inner" role="listbox">
                                <div class="item @(Model.Question.DefaultImgId.ToString()=="00000000-0000-0000-0000-000000000000"?"active":"")">
                                    <div class="col-md-4">
                                        <div class="card">
                                            <img class="card-img-top" src="/images/defaultScene.jpg" alt="默认图片" imgId="00000000-0000-0000-0000-000000000000">
                                            <div class="card-body">
                                                <h6 class="card-title">默认图片</h6>
                                                <p class="card-text"></p>
                                                <a class="btn" style="visibility: hidden;"></a>
                                                <i class="material-icons md-green md-30 pull-right ">check_circle</i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                @if (imgs != null && imgs.Count > 0)
                                    {
                                        var loopCount = 0;

                                        foreach (var scene in scenes)
                                        {
                                            loopCount = 0;
                                            var fileList = imgs.Where(i => i.SceneId == scene.Id).ToList();
                                            foreach (var img in fileList)
                                            {
                                                var isDefaultImg = Model.Question.DefaultImgId == img.Id;
                                                if (loopCount %3==0 || loopCount == 0)
                                                {
                                @: <div class="item @(isDefaultImg?"active":"")">
                                                    }
                                    <div class="col-md-4" data-sceneImg="1" data-scene-id="@img.File.Id">
                                        <div class="card">
                                            <img class="card-img-top" src="@img.File.FilePath" alt="Card image cap">
                                            <div class="card-body">
                                                <h6 class="card-title">@img.SceneFileName</h6>
                                                <p class="card-text"></p>
                                                <a class="btn btn-primary @(isDefaultImg?"visible-hidden":"")" data-scene-img-id="@img.File.Id">选择</a>
                                                <i class="material-icons md-green md-30 pull-right  @(isDefaultImg?"":"scene-img")">check_circle</i>
                                            </div>
                                        </div>
                                    </div>
                                                if ((loopCount+1) %3==0 || loopCount == fileList.Count()-1)
                                                    {
                                @:   </div>
                                                }
                                                loopCount++;
                                            }
                                        }
                                    }
                            </div>
                            <!--/.Slides-->

                        </div>
                        <!--/.Carousel Wrapper-->
                    </div>
                </div>
                <div role="tabpanel" class="tab-pane animated fadeIn" id="create-question-roles">
                    <div class="row">
                        <div class="col-sm-12 ">

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@Html.Partial("~/Views/Shared/Modals/_ModalFooterWithSaveAndCancel.cshtml")

<script src="~/view-resources/Views/Questions/_EditQuestion.js" asp-append-version="true"></script>
